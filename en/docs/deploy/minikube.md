# Deploying WSO2 Identity Server on Kubernetes Minikube 

!!! info "Prerequisites"
    need details. 

Minikube environment supports deploying applications locally.  

### Step 1 - Install Minikube

See instructions to install Minikube [here](https://kubernetes.io/docs/setup/learning-environment/minikube/#installation).

### Step 2 - Install Ingress Controller

!!! note 
    The ingress controller addon provided for Mini Kube doesn’t support SSL passthrough. Hence, we need to deploy the modified Kubernetes manifest to deploy an ingress controller with SSL passthrough instead of applying the addon.

1.  Clone [this](https://github.com/ajanthan/minikube-ingress-with-ssl-passthrough) repository and copy the manifests to '~/.minikube/addons' as shown below. 

2.  Restart the Mini Kube.

```java
git clone https://github.com/ajanthan/minikube-ingress-with-ssl-passthrough.git
cd minikube-ingress-with-ssl-passthrough
cp *.yaml ~/.minikube/addons
minikube stop
minikube start
```

### Step 3 - Install WSO2 Identity Server and update configurations

!!! note 
    If you do not want to make changes manually, you can use [this](https://github.com/ajanthan/kubernetes-is) repository with the updated changes and skip to [Step 4](#step). 

1.  Clone the WSO2 Kubernetes resource git repository locally. 

    ```java
    git clone https://github.com/wso2/kubernetes-is.git
    ```

2.  Make the following changes to enable Hostpath persistence volume type for WSO2 identity server persistence volume configuration and Mysql. 

    !!! note
        Persistence volume is used to store the data generated by Mysql POD and WSO2 Identity Server POD. By default, NFS is used as the persistence volume provider. For MiniKube-based local setup, setting hostpath persistence volume type simplifies the deployment process since it mounts a folder from the host machine instead of mandating an NFS.

    **MySQL**
    
    ![persistent](../assets/img/deploy/persistent.png)

    **WSO2 IS**

    ![isconfig](../assets/img/deploy/isconfig.png)

3.  Make the following changes to run containers as the root user.

    !!! note 
        When the Hostpath volume persistence is used with MiniKube, the container needs root access to access the attached volume since the Mini Kube VM doesn’t have any none-root users. Creating a none user in MiniKube VM is not straightforward. To make things simpler, here we are going to run WSO2 Identity server container and the Mysql container as root. 

        !!! warning
            Running container as root in production is strictly **not recommended**. This method is shown only for demo purposes. 

    **MySQL Container**

    ![mysqlcont.png](../assets/img/deploy/mysqlcont.png)

    **WSO2 IS Container**

    ![iscont.png](../assets/img/deploy/iscont.png)

4.  The default WSO2 Identity server POD uses an image which requires a trial license from WSO2 because it has bugfix patches which are under a commercial license. Hence, we use the opensource version of the images from the official **docker hub**.

    ![docker.png](../assets/img/deploy/docker.png)

5.  Diable clustering as follws since we do not need it for single-node deployment. 

    ![cluster.png](../assets/img/deploy/cluster.png)

<a name = "step"></a>

### Step 4 - Deploy WSO2 Identity Server

1.  Deploy the volumes and create service accounts as shown below. 

    ```java
    kubectl create serviceaccount wso2svc-account
    kubectl create -f is/volumes/persistent-volumes.yaml
    kubectl create -f is/identity-server-volume-claims.yaml
    ```

2.  Apply the configMaps with all the customized configurations for Kubernetes. 

    ```java
    kubectl create configmap identity-server-conf --from-file=is/confs/
    kubectl create configmap identity-server-conf-axis2 --from-file=is/confs/axis2/
    kubectl create configmap identity-server-conf-datasources --from-file=is/confs/datasources/
    kubectl create configmap identity-server-conf-identity --from-file=is/confs/identity/
    ```

3.  Apply the deployment and service for for exposing WSO2 identity server for internal access. 

    ```java
    kubectl create -f is/identity-server-deployment.yaml
    ```

4.  Wait until the server is up and running. You may check the logs of the WSO2 IS POD to confirm this. 
    
    ```java
    kubectl logs <WSO2 IS POD name> -f
    ```

5.  Deploy the service description and ingress controller.

    ```java
    kubectl create -f is/identity-server-service.yaml
    kubectl create -f is/ingresses/identity-server-ingress.yaml 
    ```

6.  Update the DNS entry for the WSO2 IS hostname. In oder to get the IP address for the hostname issue the following command.

    ```java
    minikube ip
    ```

7.  Update `/etc/hosts`  with the IP address you obtained in the previous step.  

    ```java
    192.168.64.6 wso2is
    ```

Now you can access the management console at https://wso2is/carbon!

Since you now know how to deploy WSO2 Identity Server, make sure you try it with two or more nodes [here](). You can also try our [quick start guide]() to find out what you can do with our product. 

### Shutting down the Setup 

When you are ready to tear down the setup, issue following commands in the given order.

```java
kubectl delete -f is/identity-server-volume-claims.yaml
kubectl delete -f is/volumes/persistent-volumes.yaml
kubectl delete -f is/identity-server-service.yaml
kubectl delete -f is/identity-server-deployment.yaml
kubectl delete -f is/extras/rdbms/mysql/mysql-service.yaml
kubectl delete -f is/extras/rdbms/mysql/mysql-deployment.yaml
kubectl delete -f is/extras/rdbms/mysql/mysql-persistent-volume-claim.yaml
kubectl delete -f is/extras/rdbms/volumes/persistent-volumes.yaml
kubectl delete -f is/ingresses/identity-server-ingress.yaml
kubectl delete serviceaccount wso2svc-account
```
